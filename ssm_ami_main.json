{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": " This cloudformation template creates resources required to set up a Automated AMI Pipeline",
    "Parameters": {
    
   "productName": {
      "Type": "String",
      "Default": "ProductName-ProductVersion",
      "Description": "The product for which you intend to use the ami pipeline."
    },
    "productOSAndVersion": {
      "Type": "String",
      "Default": "OSName-OSversion",
      "Description": "Operating system name and OS version."
    },
     "buildVersion": {
      "Type": "String",
      "Default": "1",
      "Description": "Build-Version corresponding to your product"
    },
    "cidrVPC" : {
      "Description" : "An available CIDR block for creating a new VPC. This VPC is only for creating the AMI",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "10.0.0.0/16",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
     "cidrPrivateSubnet" : {
      "Description" : "An available CIDR block for creating a new VPC. The size of the VPC should be big enough to hold instances of all your golden AMIs at a time",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "10.0.1.0/24",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
     "cidrPublicSubnet" : {
      "Description" : "An available CIDR block for creating a new VPC. The size of the VPC should be big enough to hold instances of all your golden AMIs at a time",
      "Type": "String",
      "MinLength": "9",
      "MaxLength": "18",
      "Default": "10.0.2.0/24",
      "AllowedPattern": "(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})\\.(\\d{1,3})/(\\d{1,2})",
      "ConstraintDescription": "must be a valid IP CIDR range of the form x.x.x.x/x."
    },
    "instanceType":
    {
         "Type": "String",
      "Default": "t2.micro",
      "Description": "Specify the the InstanceType compatible with all your golden AMIs. This InstanceType will be used for launching continuous vulnerability assessment of golden AMIs."
    }
       
    },
    "Mappings" : {
        "RegionMap" : {
          "us-east-1"        : {"HVM64" : "ami-04b9e92b5572fa0d1"},
          "us-east-2"        : {"HVM64" : "ami-0d5d9d301c853a04a"},
          "us-west-1"        : {"HVM64" : "ami-0dd655843c87b6930"},
          "us-west-2"        : {"HVM64" : "ami-06d51e91cea0dac8d"},
          "eu-west-1"        : {"HVM64" : "ami-02df9ea15c1778c9c"},
          "eu-west-2"        : {"HVM64" : "ami-0be057a22c63962cb"},
          "ap-northeast-1"   : {"HVM64" : "ami-0f9af249e7fa6f61b"},
          "ap-southeast-1"   : {"HVM64" : "ami-061eb2b23f9f8839c"},
          "ap-southeast-2"   : {"HVM64" : "ami-00a54827eb7ffcd3c"}
        }
      },

    "Resources": {

    "VPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": {
        "EnableDnsSupport": "true",
        "EnableDnsHostnames": "true",
        "CidrBlock": {"Ref":"cidrVPC"}
      } 
    },
    "subnetPrivate": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "CidrBlock": {"Ref":"cidrPrivateSubnet"},
        "VpcId": {
          "Ref": "VPC"
        }
      } 
    },
      "subnetPublic": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "MapPublicIpOnLaunch" : true,
        "CidrBlock": {"Ref":"cidrPublicSubnet"},
        "VpcId": {
          "Ref": "VPC"
        }
      } 
    },
     "InternetGateway": {
      "Type": "AWS::EC2::InternetGateway" 
    },
    "PublicVPCGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "InternetGatewayId": {
          "Ref": "InternetGateway"
        }
      }
    },
    "PublicRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        }
      } 
    },
    "PublicRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "PublicVPCGatewayAttachment",
      "Properties": {
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        },
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": {
          "Ref": "InternetGateway"
        }
      } 
    },
    "PublicSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "subnetPublic"
        },
        "RouteTableId": {
          "Ref": "PublicRouteTable"
        }
      } 
    },  
    "NAT" : {
      "DependsOn" : "PublicVPCGatewayAttachment",
      "Type" : "AWS::EC2::NatGateway",
      "Properties" : {
        "AllocationId" : { "Fn::GetAtt" : ["EIP", "AllocationId"]},
        "SubnetId" : { "Ref" : "subnetPublic"}
      }
    },  
    "PrivateRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        }
      } 
    },
    "EIP" : {
      "Type" : "AWS::EC2::EIP",
      "Properties" : {
        "Domain" : "vpc"
      }
    },
    "PrivateRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "PublicVPCGatewayAttachment",
      "Properties" : 
      {
        "RouteTableId" : { "Ref" : "PrivateRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "NatGatewayId" : { "Ref" : "NAT" } 
    }
    },
    "PrivateSubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "SubnetId": {
          "Ref": "subnetPrivate"
        },
        "RouteTableId": {
          "Ref": "PrivateRouteTable"
        }
      } 
    }, 

 "secGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": {
          "Ref": "VPC"
        },
        "GroupDescription": "Allow HTTP traffic",
        "SecurityGroupIngress": []
      } 
    },
        
        "ManagedInstanceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ssm.amazonaws.com",
                                    "ec2.amazonaws.com"
                                ]
                            },

                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM"
                ],
                "Path": "/"
            }
        },
        "ManagedInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "ManagedInstanceRole"
                    }
                ]
            }
        },
        "AutomationServiceRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ssm.amazonaws.com",
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": "sts:AssumeRole"
                        }
                    ]
                },
                "ManagedPolicyArns": [
                    "arn:aws:iam::aws:policy/service-role/AmazonSSMAutomationRole"
                ],
                "Path": "/",
                "Policies": [
                    {
                        "PolicyName": "passrole",
                        "PolicyDocument": {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:PassRole"
                                    ],
                                    "Resource": [
                                        {
                                            "Fn::GetAtt": [
                                                "ManagedInstanceRole",
                                                "Arn"
                                            ]
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                    
                ]
            }
        }, 
        "AMIAutomationDoc": {
            "Type": "AWS::SSM::Document",
           
            "Properties": {
                "DocumentType": "Automation",
                "Content": {
                    "description": "This automation document triggers AMI creation workflow.",
                    "schemaVersion": "0.3",
                    "assumeRole": {
                        "Fn::GetAtt": [
                            "AutomationServiceRole",
                            "Arn"
                        ]
                    },
                    "parameters": {
                        "sourceAMIid": {
                            "type": "String",
                            "description": "Source/Base AMI to be used for generating your golden AMI",
                            "default": { "Fn::FindInMap" : [ "RegionMap", { "Ref" : "AWS::Region" }, "HVM64"]}
                        },
                      
                        "productName": {
                            "type": "String",
                            "description": "The syntax of this parameter is ProductName-ProductVersion.",
                            "default": {
                                "Ref": "productName"
                            }
                        },
                         "productOSAndVersion": {
                            "type": "String",
                            "description": "The syntax of this parameter is OSName-OSVersion",
                            "default": {
                                "Ref": "productOSAndVersion"
                            }
                        },
                          "AMIVersion": {
                            "type": "String",
                            "description": "Golden AMI Build version number to be created.",
                            "default": {
                                "Ref": "buildVersion"
                            }
                        },

                        "subnetId": {
                            "type": "String",
                            "default":{
                                "Ref": "subnetPrivate"
                            },
                            "description": "Subnet in which instances will be launched."
                        },
                        "securityGroupId": {
                            "type": "String",
                            "default":{
                                "Ref": "secGroup"
                            },
                            "description": "Security Group that will be attached to the instance. By Default a security group without any inbound access is attached"
                        },
                        "instanceType": {
                            "type": "String",
                            "description": "A compatible instance-type for launching an instance",
                            "default": {
                                "Ref": "instanceType"
                            }
                        },
                        "targetAMIname": {
                            "type": "String",
                            "description": "Name for the golden AMI to be created",
                            "default": "{{productName}}-{{productOSAndVersion}}-{{AMIVersion}}"
                        }, 
                      
                        "ManagedInstanceProfile": {
                            "type": "String",
                            "description": "Instance Profile. Do not change the default value.",
                            "default": {
                                "Ref": "ManagedInstanceProfile"
                            }
                        },
                         "SSMInstallationUserData": {
                            "type": "String",
                            "description": "Base64 encoded SSM installation user-data.",
                            "default": "IyEvYmluL2Jhc2gKCiMgLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIE1haW4gU2NyaXB0IGZvciB0aGUgV1NPMiBQcm9kdWN0cyBzZXR1cAojIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLQojIEV4aXQgb24gZmFpbApzZXQgLWUKCmV4cG9ydCBMQ19BTEw9ZW5fVVMuVVRGLTgKZXhwb3J0IExBTkc9ZW5fVVMuVVRGLTgKCiNVcGRhdGUgdGhlIEFNSQplY2hvICJnZXR0aW5nIHJlcG9zaXRvcnkgdXBkYXRlcyIKc3VkbyBhcHQtZ2V0IHVwZGF0ZQoKI0luc3RhbGwgcHJlLXJlcXVpcmVkIHBhY2thZ2VzCmVjaG8gImluc3RhbGxpbmcgcGFja2FnZXMiCnN1ZG8gYXB0LWdldCBpbnN0YWxsIC15IGRjIGxpYnlhbWwtZGV2IG50cGRhdGUgb3BlbnNzaC1zZXJ2ZXIgcHVwcGV0IG1jb2xsZWN0aXZlIHNubXAgemlwIHRyZWUgdmltIGh0b3AgY2N6ZSB4ZnNwcm9ncyBuYWdpb3MtbnJwZS1zZXJ2ZXIgbmFnaW9zLXBsdWdpbnMgc25tcGQgbHNvZiBzeXNzdGF0IGN1cmwgdW56aXAgZ2l0IHB5dGhvbjMgcHl0aG9uMy1waXAgZGMKCmVjaG8gImNyZWF0aW5nIHdzbzIgbG9ncyBkaXJlY3RvcnkiCnN1ZG8gbWtkaXIgLXAgL3Zhci9sb2cvd3NvMgoKZWNobyAiY3JlYXRlIGZhY3RlcnMgZGlyZWN0b3J5IgpzdWRvIG1rZGlyIC1wIC9ldGMvZmFjdGVyL2ZhY3RzLmQKCgojbWFrZSBmaWxlIHN5c3RlbSB0byBta2ZzIC9kZXYveHZkZgpzdWRvIG1rZnMueGZzIC9kZXYveHZkawoKc3VkbyBtb3VudCAvZGV2L3h2ZGsgL21udAoKZWNobyAidXBkYXRlIGZzdGFiIgpzdWRvIGNwIC9ldGMvZnN0YWIgL2V0Yy9mc3RhYi5vcmlnCgpzdWRvIGNhdCA+IGZzdGFiIDw8RU9GCkxBQkVMPWNsb3VkaW1nLXJvb3RmcwkvCSBleHQ0CWRlZmF1bHRzLGRpc2NhcmQJMCAwCi9kZXYveHZkayAgICAgIC9tbnQgICAgYXV0byAgICBkZWZhdWx0cyxub2ZhaWwsY29tbWVudD1jbG91ZGNvbmZpZyAwIDIKRU9GCgpzdWRvIG12IGZzdGFiIC9ldGMvZnN0YWIKCiNDb25maWd1cmUgdGhlIEpBVkFfSE9NRQplY2hvICJEb3dubG9hZGluZyBqYXZhIgpnaXQgY2xvbmUgaHR0cHM6Ly9naXRodWIuY29tL0NoaW50aGFrYUhhc2FrZWx1bS9zYW1wbGUuZ2l0CgptdiBzYW1wbGUgamF2YTgKCnN1ZG8gbXYgamF2YTggL29wdC8KCnN1ZG8gY2F0ID4gc2V0X2phdmFfaG9tZS5zaCA8PCBFT0YKICAgICMhL2Jpbi9iYXNoCiAgICBleHBvcnQgSjJTREtESVI9L29wdC9qYXZhOAogICAgZXhwb3J0IEoyUkVESVI9L29wdC9qYXZhOC9qcmUKICAgIGV4cG9ydCBKQVZBX0hPTUU9L29wdC9qYXZhOAogICAgI2V4cG9ydCBERVJCWV9IT01FPS9vcHQvamF2YS9kYgogICAgZXhwb3J0IFBBVEg9JEpBVkFfSE9NRS9iaW46JEoyUkVESVIvYmluOiRQQVRICkVPRgoKc3VkbyBtdiBzZXRfamF2YV9ob21lLnNoIC9ldGMvcHJvZmlsZS5kL3NldF9qYXZhX2hvbWUuc2gKCmNobW9kIDc1NCAvZXRjL3Byb2ZpbGUuZC9zZXRfamF2YV9ob21lLnNoCgoKc3VkbyB1cGRhdGUtYWx0ZXJuYXRpdmVzIC0taW5zdGFsbCAiL3Vzci9iaW4vamF2YSIgImphdmEiICIvb3B0L2phdmE4L2Jpbi9qYXZhIiAxCnN1ZG8gdXBkYXRlLWFsdGVybmF0aXZlcyAtLWluc3RhbGwgIi91c3IvYmluL2phdmFjIiAiamF2YWMiICIvb3B0L2phdmE4L2Jpbi9qYXZhYyIgMQoKCnN1ZG8gdXBkYXRlLWFsdGVybmF0aXZlcyAtLXNldCBqYXZhIC9vcHQvamF2YTgvYmluL2phdmEKc3VkbyB1cGRhdGUtYWx0ZXJuYXRpdmVzIC0tc2V0IGphdmFjIC9vcHQvamF2YTgvYmluL2phdmFjCgoKIyBjcmVhdGUgdGhlIHdzbzJ1c2VyIHVzZXIKZWNobyAiYWRkaW5nIHdzbzJ1c2VyIHVzZXIiCnN1ZG8gZ3JvdXBhZGQgd3NvMgpzdWRvIHVzZXJhZGQgLW0gLXIgIC1kIC9ob21lL3dzbzJ1c2VyIC1HIHdzbzIgLXMgL2Jpbi9iYXNoIHdzbzJ1c2VyCgojIGNyZWF0ZSB0aGUga3VydW1iYSB1c2VyCmVjaG8gImFkZGluZyBrdXJ1bWJhIHVzZXIiCnN1ZG8gZ3JvdXBhZGQga3VydW1iYQpzdWRvIHVzZXJhZGQgLW0gLXIgIC1kIC9ob21lL2t1cnVtYmEgLWcgd3NvMiAtcyAvYmluL2Jhc2gga3VydW1iYQoKI0FkZGluZyBpcHRhYmxlIHJ1bGUgZm9yIGJsb2NrIHRyYWZmaWMgMTY5LjI1NC4xNjkuMjU0IGZvciB3c28ydXNlcgojc3VkbyBpcHRhYmxlcyAtQSBPVVRQVVQgLW0gb3duZXIgISAtLXVpZC1vd25lciByb290IC1kIDE2OS4yNTQuMTY5LjI1NCAtaiBEUk9QCgojR2V0IHRoZSBKRlIgc2NyaXB0cyAKc3VkbyBta2RpciAvcm9vdC9iaW4Kc3VkbyBta2RpciAtcCAvbW50L3NjcmlwdHMvdXRpbHMgL21udC9zY3JpcHRzL21pc2MKCnN1ZG8gY2hvd24gLVIgJ3dzbzJ1c2VyOndzbzJ1c2VyJyAvbW50L3NjcmlwdHMKCmVjaG8gIkFkZGluZyBjcm9uIGZvciBkYXRlIHN5bmMiCgpzdWRvIGNhdCA+IG50cC1zeW5jIDw8IEVPRgogICAgKi81MCAqICogKiAqIC91c3Ivc2Jpbi9udHBkYXRlIHBvb2wubnRwLm9yZwpFT0YKc3VkbyBtdiBudHAtc3luYyAvZXRjL2Nyb24uZC9udHAtc3luYwojc3VkbyBtdiAvdG1wL250cC1zeW5jIC9ldGMvY3Jvbi5kLwoKI2NvbmZpZ3VyZSB0aGUgc3NoCnN1ZG8gZWNobyAidXBkYXRlaW5nIHNzaCBjb25maWdzIgpzdWRvIGNhdCA+IGJhbm5lciA8PCBFT0YKIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgICAgICAgICAgICAgICAgIEF1dGhvcml6ZWQgYWNjZXNzIG9ubHkhICAgICAgICAgICAgICAgICAgICAgIyAKIyBEaXNjb25uZWN0IElNTUVESUFURUxZIGlmIHlvdSBhcmUgbm90IGFuIGF1dGhvcml6ZWQgdXNlciEhISAjCiMgICAgICAgICBBbGwgYWN0aW9ucyBXaWxsIGJlIG1vbml0b3JlZCBhbmQgcmVjb3JkZWQgICAgICAgICAgIwojIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKRU9GCgpzdWRvIG12IGJhbm5lciAvZXRjL3NzaC9iYW5uZXIKI3N1ZG8gbXYgL3RtcC9iYW5uZXIgCgpzdWRvIGNhdCA+ICBtb3RkIDw8IEVPRgogIF9fX18gICAgICAgICAgICAgICAgXyAgICAgICAgICAgIF8gICBfICAgICAgICAgICAgIAogfCAgXyBcIF8gX18gX19fICAgX198IHxfICAgXyAgX19ffCB8XyhfKSBfX18gIF8gX18gIAogfCB8XykgfCBfXy8gXyBcIC8gXyB8IHwgfCB8LyBfX3wgX198IHwvIF8gXHwgXyBcIAogfCAgX18vfCB8IHwgKF8pIHwgKF98IHwgfF98IHwgKF9ffCB8X3wgfCAoXykgfCB8IHwgfAogfF98ICAgfF98ICBcX19fLyBcX18sX3xcX18sX3xcX19ffFxfX3xffFxfX18vfF98IHxffAoKRU9GCnN1ZG8gbXYgbW90ZCAvZXRjL21vdGQKCiMjY2hhbmdlIHRoaXMgb24gc2VuZCBBTUkgYnVpbGQgc2luY2UgcGFja2VyIHJ1biBmYWlscwplY2hvICJDaGFuZ2Ugc3NoIFBvcnQgdG8gMTk4NCIKIyNzdWRvIHNlZCAtaSAncy8jUG9ydCAyMi9Qb3J0IDE5ODQvZycgL2V0Yy9zc2gvc3NoZF9jb25maWcgICAKIyNzdWRvIGVjaG8gLWUgIlxuUG9ydCAxOTg0IiA+PiAvZXRjL3NzaC9zc2hkX2NvbmZpZwoKZWNobyAiQ2hhbmdlIFBlcm1pdFJvb3RMb2dpbiB0byBObyIKc3VkbyBzZWQgLWkgJ3MvUGVybWl0Um9vdExvZ2luIHByb2hpYml0LXBhc3N3b3JkL1Blcm1pdFJvb3RMb2dpbiBwcm9oaWJpdC1wYXNzd29yZC9nJyAvZXRjL3NzaC9zc2hkX2NvbmZpZwoKZWNobyAiQ2hhbmdlIFBhc3N3b3JkQXV0aGVudGljYXRpb24gdG8gTm8iCnN1ZG8gc2VkIC1pICdzLyNQYXNzd29yZEF1dGhlbnRpY2F0aW9uIHllcy9QYXNzd29yZEF1dGhlbnRpY2F0aW9uIG5vL2cnIC9ldGMvc3NoL3NzaGRfY29uZmlnCgplY2hvICJjaG5hZ2Ugc3NoIEJhbm5lciB0byAvZXRjL3NzaC9iYW5uZXIiCnN1ZG8gc2VkIC1pICdzLyNCYW5uZXIuKi9CYW5uZXIgXC9ldGNcL3NzaFwvYmFubmVyL2cnIC9ldGMvc3NoL3NzaGRfY29uZmlnCgplY2hvICJTU0ggU3RhdHVzOiIKZWNobyBgc2VydmljZSBzc2ggc3RhdHVzYAoKc3VkbyBjYXQgPiBzZXRfaGlzdG9yeV9mb3JtYXQuc2ggPDwgRU9GCiAgICAjIS9iaW4vYmFzaAogICAgZXhwb3J0IEhJU1RUSU1FRk9STUFUPSIlRiAlVCAiCkVPRgoKc3VkbyBtdiBzZXRfaGlzdG9yeV9mb3JtYXQuc2ggL2V0Yy9wcm9maWxlLmQvc2V0X2hpc3RvcnlfZm9ybWF0LnNoCgpzdWRvIGNhdCA+IGNsb3Vkd2F0Y2gtYmFzZS5jb25mIDw8IEVPRgogICAgW2dlbmVyYWxdCiAgICBzdGF0ZV9maWxlID0gL3Zhci9hd3Nsb2dzL3N0YXRlL2FnZW50LXN0YXRlCiAgICBbL3Zhci9sb2cvc3lzbG9nXQogICAgZGF0ZXRpbWVfZm9ybWF0ID0gJVktJW0tJWQgJUg6JU06JVMKICAgIGZpbGUgPSAvdmFyL2xvZy9zeXNsb2cKICAgIGJ1ZmZlcl9kdXJhdGlvbiA9IDUwMDAKICAgIGxvZ19zdHJlYW1fbmFtZSA9IHtob3N0bmFtZX0KICAgIGluaXRpYWxfcG9zaXRpb24gPSBlbmRfb2ZfZmlsZQogICAgbG9nX2dyb3VwX25hbWUgPSAvdmFyL2xvZy9zeXNsb2cKRU9GCgojIEluc3RhbGxpbmcgQ2xvdWRXYXRjaAplY2hvICJpbnN0YWxsaW5nIGF3c2xvZ3MgYWdlbnQiCnN1ZG8gY3VybCBodHRwczovL3MzLmFtYXpvbmF3cy5jb20vYXdzLWNsb3Vkd2F0Y2gvZG93bmxvYWRzL2xhdGVzdC9hd3Nsb2dzLWFnZW50LXNldHVwLnB5IC1PCnN1ZG8gcHl0aG9uIC4vYXdzbG9ncy1hZ2VudC1zZXR1cC5weSAtLXJlZ2lvbiB1cy1lYXN0LTEgLS1ub24taW50ZXJhY3RpdmUgLS1jb25maWdmaWxlPWNsb3Vkd2F0Y2gtYmFzZS5jb25mIC0tcHl0aG9uPS91c3IvYmluL3B5dGhvbjIuNwoKI2luc3RhbGwgYXdzIGNsaSBmcm9tIGJ1bmRsZQplY2hvICJpbnN0YWxsaW5nIGF3cyBjbGkiCmN1cmwgLS1zaWxlbnQgImh0dHBzOi8vczMuYW1hem9uYXdzLmNvbS9hd3MtY2xpL2F3c2NsaS1idW5kbGUuemlwIiAtbyAiL3RtcC9hd3NjbGktYnVuZGxlLnppcCIKdW56aXAgLXFxIC90bXAvYXdzY2xpLWJ1bmRsZS56aXAgLWQgL3RtcApzdWRvIHB5dGhvbjMgL3RtcC9hd3NjbGktYnVuZGxlL2luc3RhbGwgLWkgL3Vzci9sb2NhbC9hd3MgLWIgL3Vzci9sb2NhbC9iaW4vYXdzCgojIEluc3RhbGxpbmcgcmVuYW1lIHBhY2thZ2UKc3VkbyBhcHQtZ2V0IGluc3RhbGwgcmVuYW1lCgojIHB1cHBldAplY2hvICJSZW1vdmUgcHVwcGV0IGZyb20gc3RhcnR1cCIKc3VkbyBzZXJ2aWNlIHB1cHBldCBzdG9wCnN1ZG8gdXBkYXRlLXJjLmQgcHVwcGV0IGRpc2FibGUKCiNjb3B5IHdzbzIgcHVwcGV0IGNvbmZpZ3VyYXRpb24gZmlsZXMKc3VkbyBybSAtcmYgL3Zhci9saWIvcHVwcGV0LwoKc3VkbyBjYXQgPiA5NV9wdXBwZXQuY2ZnIDw8IEVPRgogICAgIyBUaGlzIHdpbGwgdXBkYXRlIHRoZSBwdXBwZXQuY29uZiBpbiBuZXh0IHJlYm9vdAogICAgcHVwcGV0OgogICAgY29uZjoKICAgICAgICBhZ2VudDoKICAgICAgICBzZXJ2ZXI6ICJwdXBwZXQiCiAgICAgICAgY2VydG5hbWU6ICIlaS4lZiIKICAgICAgICB3YWl0Zm9yY2VydDogIjYwIgogICAgICAgIHJlcG9ydDogInRydWUiCiAgICAgICAgZW52aXJvbm1lbnQ6ICJwcm9kdWN0aW9uIgogICAgCiAgICBydW5jbWQ6CiAgICAtIFsndXBkYXRlLXJjLmQnLCAncHVwcGV0JywgJ2VuYWJsZSddCkVPRgoKc3VkbyBtdiA5NV9wdXBwZXQuY2ZnIC9ldGMvY2xvdWQvY2xvdWQuY2ZnLmQvOTVfcHVwcGV0LmNmZwoKc3VkbyBjcCAvZXRjL3NlY3VyaXR5L2xpbWl0cy5jb25mIC9ldGMvc2VjdXJpdHkvbGltaXRzLmNvbmYub3JpZwpzdWRvIGNhdCA+IGxpbWl0cy5jb25mIDw8IEVPRgogICAgd3NvMnVzZXIgICAgICAgICBzb2Z0ICAgICBub2ZpbGUgICAgICAgICAgNjU1MzUKICAgIHdzbzJ1c2VyICAgICAgICAgaGFyZCAgICAgbm9maWxlICAgICAgICAgIDY1NTM1CiAgICB3c28ydXNlciAgICAgICAgIHNvZnQgICAgIG5wcm9jICAgICAgICAgICAyMDAwMAogICAgd3NvMnVzZXIgICAgICAgICBoYXJkICAgICBucHJvYyAgICAgICAgICAgMjAwMDAKRU9GCgpzdWRvIG12IGxpbWl0cy5jb25mICAvZXRjL3NlY3VyaXR5L2xpbWl0cy5jb25mIAoKc3VkbyBtdiAvZXRjL3N5c2N0bC5jb25mIC9ldGMvc3lzY3RsLmNvbmYub3JpZwpzdWRvIGNhdCA+IHN5c2N0bC5jb25mIDw8IEVPRgogICAgZnMuZmlsZS1tYXggPSAyMDk3MTUyCgogICAgbmV0LmNvcmUucm1lbV9kZWZhdWx0ID0gNTI0Mjg4CiAgICBuZXQuY29yZS53bWVtX2RlZmF1bHQgPSA1MjQyODgKICAgIG5ldC5jb3JlLnJtZW1fbWF4ID0gNjcxMDg4NjQKICAgIG5ldC5jb3JlLndtZW1fbWF4ID0gNjcxMDg4NjQKCiAgICBuZXQuaXB2NC50Y3BfZmluX3RpbWVvdXQgPSAzMAogICAgbmV0LmlwdjQudGNwX3JtZW0gPSA0MDk2IDg3MzgwIDE2Nzc3MjE2CiAgICBuZXQuaXB2NC50Y3Bfd21lbSA9IDQwOTYgNjU1MzYgMTY3NzcyMTYKICAgIG5ldC5pcHY0LmlwX2xvY2FsX3BvcnRfcmFuZ2UgPSAxMDI0IDY1NTM1CkVPRgoKc3VkbyBtdiBzeXNjdGwuY29uZiAvZXRjL3N5c2N0bC5jb25mCgpzdWRvIGNhdCA+IHNldF9hbGlhcy5zaCA8PCBFT0YKICAgICMhL2Jpbi9iYXNoCiAgICAjIGRvIG5vdCBkZWxldGUgLyBvciBwcm9tcHQgaWYgZGVsZXRpbmcgbW9yZSB0aGFuIDMgZmlsZXMgYXQgYSB0aW1lICMKICAgIGFsaWFzIHJtPSdybSAtSSAtLXByZXNlcnZlLXJvb3QnCiAgICAKICAgICMgY29uZmlybWF0aW9uICMKICAgIGFsaWFzIG12PSdtdiAtaScKICAgIGFsaWFzIGNwPSdjcCAtaScKICAgIGFsaWFzIGxuPSdsbiAtaScKICAgIAogICAgIyBQYXJlbnRpbmcgY2hhbmdpbmcgcGVybXMgb24gLyAjCiAgICBhbGlhcyBjaG93bj0nY2hvd24gLS1wcmVzZXJ2ZS1yb290JwogICAgYWxpYXMgY2htb2Q9J2NobW9kIC0tcHJlc2VydmUtcm9vdCcKICAgIGFsaWFzIGNoZ3JwPSdjaGdycCAtLXByZXNlcnZlLXJvb3QnCgogICAgIyBDcmVhdGluZyBuZXcgc2Vzc2lvbiB3aXRoIHN1IAogICAgYWxpYXMgc3U9J3N5c3RlbWQtcnVuIC10IC9iaW4vc3UgJwogICAgYWxpYXMgc3Vkbz0nc3VkbyAnCkVPRgoKc3VkbyBtdiBzZXRfYWxpYXMuc2ggL2V0Yy9wcm9maWxlLmQvc2V0X2FsaWFzLnNoCgpzdWRvIGNobW9kIC1SIDc1NCAvZXRjL3Byb2ZpbGUuZC8KCiNNYWtlIHB1cHBldCBsaWIgZGlyCnN1ZG8gbWtkaXIgL3Zhci9saWIvcHVwcGV0CnN1ZG8gY2hvd24gcHVwcGV0OnB1cHBldCAvdmFyL2xpYi9wdXBwZXQKc3VkbyBjaG1vZCA3NTUgL3Zhci9saWIvcHVwcGV0"
                        },
                        
                        "DeviceName": {
                            "type": "String",
                            "description": "Add the Device name that ebs should mount",
                            "default": "/dev/sdk"
                        }

                    },
                    "mainSteps": [
                        {
                            "name": "startInstances",
                            "action": "aws:runInstances",
                            "timeoutSeconds": 3600,
                            "maxAttempts": 2,
                            "onFailure": "Abort",
                            "inputs": {
                                "ImageId": "{{ sourceAMIid}}" ,
                                "InstanceType": "{{instanceType}}",
                                "MinInstanceCount": 1,
                                "MaxInstanceCount": 1,
                                "SubnetId": "{{ subnetId }}",
                                "SecurityGroupIds": [
                                    "{{ securityGroupId }}"
                                ],
                                "UserData": "{{SSMInstallationUserData}}",
                                "IamInstanceProfileName": "{{ ManagedInstanceProfile }}",
                                "BlockDeviceMappings": [
                                    {
                                      "DeviceName": "{{DeviceName}}",
                                      "Ebs": {
                                        "DeleteOnTermination": true,
                                        "VolumeSize": 25,
                                        "VolumeType": "gp2",
                                        "Encrypted": true
                                        
                                      }
                                      
                                    }
                                    
                                  ]
                                 
                            }
                        },
                        {
                            "name": "sleep",
                            "action": "aws:sleep",
                            "inputs": {
                                "Duration": "PT6M"
                            }
                        },
                        
                        {
                            "name": "stopInstance",
                            "action": "aws:changeInstanceState",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Abort",
                            "inputs": {
                                "InstanceIds": [
                                    "{{ startInstances.InstanceIds }}"
                                ],
                                "DesiredState": "stopped"
                            }
                        },
                        {
                            "name": "createImage",
                            "action": "aws:createImage",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Continue",
                            "inputs": {
                                "InstanceId": "{{ startInstances.InstanceIds }}",
                                "ImageName": "{{ targetAMIname }}",
                                "NoReboot": true,
                                "ImageDescription": "AMI created by EC2 Automation"
                            }
                        },
                        {
                            "name": "TagTheAMI",
                            "action": "aws:createTags",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Continue",
                            "inputs": {
                                "ResourceType": "EC2",
                                "ResourceIds": [
                                    "{{ createImage.ImageId }}"
                                ],
                                "Tags": [
                                    {
                                        "Key": "Name",
                                        "Value": "HASHAMI2"
                                    },
                                    {
                                        "Key": "ProductOSAndVersion",
                                        "Value": "{{productOSAndVersion}}"
                                    },
                                    {
                                        "Key": "ProductName",
                                        "Value": "{{productName}}"
                                    },
                                    {
                                        "Key": "version",
                                        "Value": "{{AMIVersion}}"
                                    },
                                    {
                                        "Key": "AMI-Type",
                                        "Value": "Golden"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "terminateFirstInstance",
                            "action": "aws:changeInstanceState",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Continue",
                            "inputs": {
                                "InstanceIds": [
                                    "{{ startInstances.InstanceIds }}"
                                ],
                                "DesiredState": "terminated"
                            }
                        },
                        {
                            "name": "createInstanceFromNewImage",
                            "action": "aws:runInstances",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Abort",
                            "inputs": {
                                "ImageId": "{{ createImage.ImageId }}",
                                "InstanceType": "{{instanceType}}",
                                "MinInstanceCount": 1,
                                "MaxInstanceCount": 1,
                                "SubnetId": "{{ subnetId }}",
                                "SecurityGroupIds": [
                                    "{{ securityGroupId }}"
                                ],
                                "IamInstanceProfileName": "{{ ManagedInstanceProfile }}"
                            }
                        },
                        {
                            "name": "InstallInspector",
                            "action": "aws:runCommand",
                            "maxAttempts": 3,
                            "timeoutSeconds": 3600,
                            "onFailure": "Abort",
                            "inputs": {
                                "DocumentName": "AmazonInspector-ManageAWSAgent",
                                "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                ],
                                "Parameters": {
                                    "Operation": "Install"
                                }
                            }
                        },
                        
                        {
                            "name": "TagNewinstance",
                            "action": "aws:createTags",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Continue",
                            "inputs": {
                                "ResourceType": "EC2",
                                "ResourceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                ],
                                "Tags": [
                                    {
                                        "Key": "Type",
                                        "Value": "{{createImage.ImageId}}-{{productOSAndVersion}}/{{productName}}/{{AMIVersion}}"
                                    },
                                     {
                                        "Key": "Automation-Instance-Type",
                                        "Value": "Golden"
                                    }
                                ]
                            }
                        },
                        {
                            "name": "terminateInspectorInstance",
                            "action": "aws:changeInstanceState",
                            "timeoutSeconds": 1200,
                            "maxAttempts": 1,
                            "onFailure": "Continue",
                            "inputs": {
                                "InstanceIds": [
                                    "{{ createInstanceFromNewImage.InstanceIds }}"
                                ],
                                "DesiredState": "terminated"
                            }
                        }
                      
                       
                    ],
                    "outputs": [
                        "createImage.ImageId"
                    ]
                }
            }
        }
 
    },
    "Outputs": {
        "AMIAutomationDoc": {
            "Description": "The Name of the document that creates Golden AMI and executes Inspector.",
            "Value": {
                "Ref": "AMIAutomationDoc"
            }
        }

    }
}
